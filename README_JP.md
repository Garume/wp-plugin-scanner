# WordPress プラグイン セキュリティスキャナー

WordPressプラグインのファイルアップロード機能を体系的に発見・分析・監査する包括的なセキュリティ分析ツールです。直感的なデスクトップインターフェースを通じて、自動化されたプラグイン発見と詳細なセキュリティスキャン機能を提供します。

## 🎯 目的と価値

WordPressプラグインには、適切にセキュリティが確保されていない場合にセキュリティリスクを引き起こす可能性のあるファイルアップロード機能が含まれていることがあります。このツールは、セキュリティ研究者、WordPress管理者、開発者が以下を実現できるよう支援します：

- **プラグインの体系的発見**: WordPress.orgリポジトリからの系統的な探索
- **アップロードパターンの分析**: 正規表現ベースのコードスキャニング
- **監査結果の追跡**: 包括的なデータベース管理機能
- **発見内容のフィルタリング・ソート**: 効率的なセキュリティレビュー
- **結果のエクスポート**: レポート作成と追加分析のための出力

## ✨ 主要機能

### プラグイン発見・管理
- **カテゴリ別ブラウジング**: 人気、最新、更新済み、お気に入りでプラグインを取得
- **キーワード検索**: WordPress.org検索APIを使用したプラグイン検索
- **一括操作**: 数百のプラグインを効率的に処理
- **レート制限**: 指数バックオフによる丁寧なAPI使用
- **進行状況追跡**: ページごとのリアルタイム状況更新

### セキュリティ分析
- **アップロードパターン検出**: `wp_handle_upload`、`media_handle_upload`、`$_FILES`をスキャン
- **ファイルレベル分析**: 正確なファイルパスと行番号の報告
- **マッチのハイライト**: 検出を引き起こした実際のコードスニペットを表示
- **包括的レポート**: スキャンされたファイル数とマッチ統計

### データ管理
- **二重ストレージ**: SQLiteデータベースとCSVエクスポートオプション
- **プラグインメタデータ**: 完全なプラグイン情報（作者、バージョン、ダウンロード数、評価）
- **監査履歴**: プラグインが分析された時期の追跡
- **高度なフィルタリング**: 監査状況による絞り込み、様々な条件でのソート
- **データベースビューア**: 検索とフィルタ機能で収集したデータを閲覧

### ユーザーインターフェース
- **日本語/英語サポート**: 完全にローカライズされたインターフェース
- **3タブレイアウト**: 発見から分析までの整理されたワークフロー
- **リアルタイムフィードバック**: 進行状況バーと状況更新
- **エクスポート機能**: フィルタリングされた結果のCSVエクスポート
- **エラーハンドリング**: 詳細なエラーメッセージによる優雅な失敗処理

## 🚀 クイックスタート

### 前提条件
- Python 3.10以上
- tkinter（通常Pythonに含まれています）
- WordPress.org API アクセス用のインターネット接続

### インストール
```bash
# リポジトリをクローン
git clone https://github.com/your-repo/wp-plugin-scanner.git
cd wp-plugin-scanner

# 依存関係をインストール
pip install -r requirements.txt

# GUIを起動
python main.py
```

### 初回使用ワークフロー
1. **GUI起動** → デスクトップインターフェースで開始
2. **プラグイン閲覧** → "プラグイン一覧"タブへ移動、カテゴリを選択、"取得開始"をクリック
3. **詳細情報の自動保存** → システムが自動的にプラグインメタデータを保存
4. **セキュリティ監査実行** → "プラグイン監査"タブへ移動、プラグインを選択、分析を実行
5. **結果の確認** → "データベース閲覧"タブを使用して発見内容をフィルタリング・検証

## 📋 詳細使用ガイド

### ステップ1: プラグイン発見

#### 方法A: カテゴリベースの発見
```
プラグイン一覧タブ → カテゴリ選択（人気/最新/更新済み/お気に入り） → オプション設定 → 取得開始
```

**設定オプション:**
- **カテゴリ**: 人気、最新、最近更新、お気に入りから選択
- **制限**: 最大プラグイン数を設定（または包括的スキャンのためにチェックを外す）
- **間隔**: APIリクエスト間隔（最小1秒、推奨2秒以上）

**ベストプラクティス:**
- 価値の高いターゲットには「人気」カテゴリから開始
- 初期探索には制限（50-100）を使用
- レート制限に遭遇した場合は間隔を増やす

#### 方法B: キーワード検索
```
プラグイン一覧タブ → 検索語句を入力 → 取得開始
```

**検索戦略:**
- 具体的な用語: "upload", "media", "file", "attachment"
- セキュリティ関連: "security", "backup", "migration"
- 機能: "gallery", "form", "ecommerce"

### ステップ2: 自動プラグイン詳細収集

プラグインが発見されると、システムは自動的に：
1. **完全なメタデータを取得** WordPress.org APIから
2. **データベースに保存** 永続的なアクセスのため
3. **一括詳細取得を提供** 包括的なデータ収集のため

**取得される情報:**
- プラグイン名、バージョン、作者、説明
- ダウンロード数、アクティブインストール数、評価
- 最終更新日、WordPress互換性
- タグ、貢献者、スクリーンショット、バナー

### ステップ3: セキュリティ監査実行

#### 監査対象プラグインの選択
```
プラグイン監査タブ → プラグインスラッグを入力 → オプション設定 → 監査実行
```

**入力方法:**
- **手動入力**: プラグインスラッグをタイプ（カンマまたはスペース区切り）
- **データベースからコピー**: データベースビューアの"監査にスラッグをコピー"ボタンを使用
- **一括選択**: データベースビューアで複数のプラグインを選択

**監査設定:**
- **ソースファイルを保存**: 手動レビューのためにダウンロードしたプラグインファイルを保持
- **出力形式**: SQLite（推奨）またはCSVを選択
- **並行処理**: ツールが自動的に並列処理を管理

#### 監査結果の理解

**監査状況の意味:**
- **✓ True**: アップロード機能が検出された
- **✗ False**: アップロードパターンが見つからない
- **- 未監査**: プラグインがまだ分析されていない
- **エラー**: 監査が失敗（ネットワーク、展開、パースエラー）

### ステップ4: 結果分析・フィルタリング

#### データベースビューア機能
```
データベース閲覧タブ → フィルタ適用 → 結果確認 → 必要に応じてエクスポート
```

**フィルタリングオプション:**
- **検索**: プラグイン名、作者、説明
- **監査状況**: 全て、True発見、False発見、未監査
- **ソート**: 名前、ダウンロード数、評価、最終更新、監査タイムスタンプ
- **ソート順**: 昇順または降順

**実用的なフィルタ例:**
1. **高リスク発見**: 監査状況 = "True"、ソート "ダウンロード数" 降順
2. **人気な未監査**: 監査状況 = "未監査"、ソート "ダウンロード数" 降順
3. **最近の更新**: ソート "最終更新" 降順
4. **最高評価**: ソート "評価" 降順

#### 詳細分析
- **ダブルクリック**: 任意のプラグインの完全なメタデータ表示
- **監査結果表示** ボタンでファイルごとのスキャン詳細を表示
- **エクスポート**: フィルタリングされた結果を外部分析用にCSVへ

## 🔧 高度な機能

### コマンドラインインターフェース
GUIが推奨されますが、CLIも利用可能です：

```bash
# 特定のプラグインをスキャン
python main.py plugin-slug1 plugin-slug2

# キーワードで検索してスキャン
python main.py --search "upload"

# 出力形式を設定
python main.py --db-sqlite plugin-slug

# ファイル保存を無効化
python main.py --nosave plugin-slug
```

### APIレート制限・ベストプラクティス

ツールは高度なレート制限を実装：
- **429エラーでの指数バックオフ**
- **丁寧な識別のためのUser-Agentヘッダー**
- **リクエスト間の設定可能な間隔**
- **段階的遅延での自動リトライロジック**

**推奨設定:**
- **間隔**: 持続的操作には2秒以上
- **制限**: セッションあたり100-500プラグイン
- **ピーク時間**: WordPress.orgメンテナンス時間を避ける

### データベース管理

**作成されるファイル:**
- `plugin_details.db`: 全プラグイン情報を含むメインSQLiteデータベース
- `plugin_upload_audit.db`: 監査結果（別監査DBを使用する場合）
- `plugin_upload_audit.csv`: CSV形式の結果
- `saved_plugins/`: ダウンロードしたプラグインソースコード（有効な場合）

**メンテナンス:**
- 古いエントリの削除には"選択した項目を削除"を使用
- 大きな更新前にエクスポート
- 大規模データセットには定期バックアップを推奨

## 🛠️ トラブルシューティング

### よくある問題

#### "429 Too Many Requests" エラー
**症状**: レート制限メッセージ、ダウンロード失敗
**解決策**: 
- 間隔を3秒以上に増加
- 並行操作を減らす
- "停止"ボタンを使用して後で再試行

#### データベースビューアで"プラグインが見つからない"
**症状**: 成功したスキャンにもかかわらず空のデータベースビューア
**解決策**:
- "詳細の自動取得"が有効でプラグインが保存されているか確認
- データベースファイルの権限を確認
- "更新"ボタンでデータを再読み込み

#### 操作中のGUIフリーズ
**症状**: スキャン中の応答しないインターフェース
**解決策**:
- "停止"ボタンで操作をキャンセル
- バッチサイズを減らす
- メモリ解放のため他のアプリケーションを閉じる

#### スキャン後の監査結果の欠如
**症状**: 監査完了したが結果が見えない
**解決策**:
- 出力形式設定（SQLite vs CSV）を確認
- 監査データベースファイルの場所を確認
- "フィルタ適用"でデータベースビューを更新

### デバッグ情報

デバッグ出力を有効にするには：
```bash
python main.py --debug
```

デバッグ情報には以下が含まれます：
- データベース接続状況
- 監査結果読み込み詳細
- APIレスポンスコード
- ファイル処理状況

## 🏗️ 技術アーキテクチャ

### コアコンポーネント
- **AuditManager**: スキャンワークフローの調整
- **PluginLister**: カテゴリ別プラグイン発見
- **PluginSearcher**: キーワードによるプラグイン検索
- **PluginDetailFetcher**: 完全なプラグインメタデータの取得
- **UploadScanner**: アップロードパターンのコード分析
- **Reporters**: SQLite/CSVデータ永続化の処理

### データフロー
1. **発見** → リストまたは検索によりプラグインスラッグを収集
2. **詳細取得** → 完全なメタデータの取得と保存
3. **セキュリティスキャン** → アップロードパターンのソースコード分析
4. **結果保存** → ファイルレベル詳細と共に発見内容をデータベースに保存
5. **分析** → データベースビューアがフィルタリングとエクスポート機能を提供

### セキュリティパターン
スキャナーは以下のアップロード関連パターンを検出：
```regex
(wp_handle_upload|media_handle_upload|\$_FILES\b)
```

**パターンの説明:**
- `wp_handle_upload`: WordPressコアのアップロードハンドラー
- `media_handle_upload`: WordPressメディアアップロード関数
- `$_FILES`: PHPファイルアップロードスーパーグローバル

## 📊 出力形式

### SQLiteデータベーススキーマ
```sql
-- プラグインメタデータ
CREATE TABLE plugin_details (
    slug TEXT PRIMARY KEY,
    name TEXT, version TEXT, author TEXT,
    description TEXT, last_updated TEXT,
    active_installs TEXT, rating REAL,
    downloaded INTEGER, tags TEXT,
    -- ... 追加のメタデータフィールド
);

-- ファイルレベル詳細を含む監査結果
CREATE TABLE plugin_audit_results (
    id INTEGER PRIMARY KEY,
    slug TEXT, upload TEXT, timestamp TEXT,
    files_scanned INTEGER, matches_count INTEGER,
    file_path TEXT, line_number INTEGER,
    line_content TEXT, matched_pattern TEXT
);
```

### CSVエクスポート形式
```csv
Slug,Name,Version,Author,Active Installs,Rating,Last Updated,Audit Result,Matches
plugin-slug,Plugin Name,1.0.0,Author Name,1000+,4.5,2024-01-01,✓ True,3
```

## 🤝 貢献

### 開発環境セットアップ
```bash
# 開発依存関係をインストール
pip install -r requirements.txt

# テスト実行
python -m unittest tests/ -v

# コードフォーマット
python -m black wp_plugin_scanner/
```

### 新しいスキャンパターンの追加
`wp_plugin_scanner/config.py`を編集：
```python
UPLOAD_PATTERN = re.compile(
    rb"(wp_handle_upload|media_handle_upload|\$_FILES\b|your_new_pattern)",
    re.I | re.S,
)
```

## 📄 ライセンス

このプロジェクトはMITライセンスの下でライセンスされています - 詳細はLICENSEファイルを参照してください。

## ⚠️ 免責事項

このツールは正当なセキュリティ研究とWordPress管理を目的としています。ユーザーは以下について責任を負います：
- WordPress.org APIの利用規約の遵守
- サービス中断を避けるための適切なリクエストレートの使用
- ダウンロードしたプラグインコードの適切なセキュリティ確保
- 発見された脆弱性に対する責任ある開示の実践

このツールは静的分析のみを実行し、プラグインコードの実行や実際の脆弱性のテストは行いません。